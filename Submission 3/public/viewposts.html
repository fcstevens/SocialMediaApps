<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap"
      rel="stylesheet"
    />
    <title>Pic-A-Pet</title>
    <style>
      img.post-image-thumbnail {
        width: 50%;
        padding-left: 10px;
        padding-top: 10px;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="app">
        <img class="logo-nav" src="images/logo-navbar.png" />
      </a>
      <a href="login.html">Login</a>
      <a href="logout.html">Logout</a>
      <a href="register.html">Register</a>
      <a class="picPet" href="app">Feed</a>
      <a class="picPetMessage" href="message.html">Messages</a>
      <a class="picPetProfile" href="profile.html">Profile</a>
    </nav>
    <br />
    <h1>
      Welcome to Pic-a-Pet, a social media platform for all animal related
      content!
    </h1>
    <div class="text-container">
      <h3>
        Welcome to our social media app for pet lovers! This is a platform
        designed for people who love animals and want to connect with other pet
        owners. Our app allows you to share photos and stories of your pets,
        follow other users who have similar interests, and engage in discussions
        with fellow pet lovers. Whether you have a dog, cat, bird, or any other
        furry friend, this app is the perfect place for you to connect with
        others who share your passion for animals. Join our community today and
        start sharing your love for pets!
      </h3>
    </div>
    <h2>Recent Posts</h2>

    <div class="centre">
      <button class="newPostButton" onclick="newPostPage()">Post</button>
    </div>
    <br />
    <div id="recentPostsListContainer">
      <div>
        <ul id="recent-posts"></ul>
      </div>
    </div>

    <script>
      let recentPosts = [];

      let recentPostsList = document.querySelector("#recent-posts");

      fetch("/getposts")
        .then((response) => response.json())
        .then((fetchedData) => {
          recentPosts = fetchedData.posts;
          console.log(fetchedData.posts);
          handleServerData();
        });

      function handleServerData() {
        recentPostsList.innerHTML = "";
        recentPosts.forEach(function (post) {
          // console.log(post._id.toString(), post.likes);
          let li = document.createElement("li");
          let liText = document.createElement("p");
          liText.textContent = `${post.message} (by ${post.postedBy}) [likes:${post.likes}]`;
          //create a 'like' button
          let button = document.createElement("button");
          button.textContent = "like";
          button.addEventListener("click", processLike);
          //add a unique attribute for the like button so it knows which post it belongs to
          button.setAttribute("data-post-id", post._id.toString());

          // Create a 'message' button and input field
          let messageButton = document.createElement("button");
          messageButton.textContent = "Message";
          messageButton.classList.add("message-btn");
          messageButton.setAttribute("data-pet-id", post._id.toString());

          let messageInput = document.createElement("input");
          messageInput.type = "text";
          messageInput.classList.add("message-input");
          messageInput.placeholder = "Enter your message";

          // Create a 'delete' button
          let deleteButton = document.createElement("button");
          deleteButton.textContent = "Delete";
          deleteButton.addEventListener("click", function () {
            deletePost(post._id);
          });

          //create a 'view and comment' button
          let viewButton = document.createElement("button");
          viewButton.textContent = "view and comment";
          viewButton.addEventListener("click", processView);
          //add a unique attribute for the like button so it knows which post it belongs to
          viewButton.setAttribute("view-post-id", post._id.toString());

          // show image if present
          if (post.imagePath) {
            let postImage = document.createElement("img");
            postImage.src = post.imagePath;
            postImage.alt = "temporary alt tag";
            postImage.classList.add("post-image-thumbnail");
            li.appendChild(postImage);
          } else {
            let noPostImage = document.createElement("p");
            noPostImage.textContent = "alas, no image!";
            li.appendChild(noPostImage);
          }

          li.appendChild(liText);
          li.appendChild(button);
          li.appendChild(deleteButton);
          li.appendChild(viewButton);
          li.appendChild(messageButton);
          li.appendChild(messageInput);
          // grab the comments list
          let comments = post.comments;
          if (comments.length > 0) {
            //add a list of comments
            let commentsUL = document.createElement("ul");
            comments.forEach(function (comment) {
              let commentLi = document.createElement("li");
              let commentLiText = document.createElement("p");
              commentLiText.textContent = `${comment.message} (by ${comment.user}) [likes:${comment.likes}]`;
              //add like button and code to handle like later
              commentLi.appendChild(commentLiText);
              commentsUL.appendChild(commentLi);
            });
            li.appendChild(commentsUL);
          }

          recentPostsList.appendChild(li);
        });
      }

      function processLike(event) {
        let likedPostId = event.target.getAttribute("data-post-id");
        // console.log('you liked '+likedPostId)
        let options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            likedPostID: likedPostId,
          }),
        };
        fetch("/like", options)
          .then((response) => response.json())
          .then((fetchedData) => {
            recentPosts = fetchedData.posts;
            handleServerData();
          });
      }

      // If view post button is pressed, grab its post id attribute and
      // direct the user to the view post page with this added in
      // url search params
      function processView(event) {
        let viewPostId = event.target.getAttribute("view-post-id");
        console.log(
          window.location.origin + "/viewpost.html?post=" + viewPostId
        );
        window.location =
          window.location.origin + "/viewpost.html?post=" + viewPostId;
      }

      //if user press 'new post' button, direct them to the new post page
      function newPostPage() {
        window.location = window.location =
          window.location.origin + "/newpost.html";
      }

      function deletePost(postId) {
        let options = {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        };

        fetch(`/deletepost/${postId}`, options)
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Post deleted successfully
              // Refresh the posts after deletion
              fetch("/getposts")
                .then((response) => response.json())
                .then((fetchedData) => {
                  recentPosts = fetchedData.posts;
                  handleServerData();
                });
            } else {
              console.log("Post deletion failed");
            }
          })
          .catch((error) => {
            console.log("Error occurred during post deletion:", error);
          });
      }
    </script>
  </body>
</html>
