<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu&display=swap"
      rel="stylesheet"
    />
    <title>Pic-A-Pet</title>

    <style>
      #post-img {
        width: 80%;
        padding-top: 20px;
      }
    </style>
  </head>
  <body>
    <nav>
      <a href="app">
        <img class="logo-nav" src="images/logo-navbar.png" />
      </a>
      <a href="login.html">Login</a>
      <a href="logout.html">Logout</a>
      <a href="register.html">Register</a>
      <a class="picPet" href="app">Feed</a>
      <a class="picPetMessage" href="message.html">Messages</a>
      <a class="picPetProfile" href="profile.html">Profile</a>
    </nav>
    <br />

    <h2>Posted Pet</h2>
    <br />
    <div id="recentPostsListContainer">
      <div id="post">
        <img id="post-img" src="" alt="" />
        <p>
          <h3> Caption:</h3>
          <span id="post-message">message:</span><span id="post-message"></span>
        </p>
      </div>
      <div id="comments">
        <h3> Comment Section:</h3>
        <ul id="post-comments"></ul>
    </div>
    <form id="comment-form" action="/comment" method="POST">
      <label for="message">Enter a comment:</label>
      <input type="text" id="message" name="message" /><br />
      <input type="submit" value="Post Comment" />
    </form>
  </div>
  <br>
  

    <script>
      //get js pointers to the html elements
      let postImage = document.querySelector("#post-img");
      let postMessage = document.querySelector("#post-message");
      let postComments = document.querySelector("#post-comments");

      //get the postid from the url query string
      const queryString = window.location.search;
      const urlParams = new URLSearchParams(queryString);
      let selectedPost = urlParams.get("post");

      let form = document.querySelector("#comment-form");
      //add a hidden form field with the postid in it
      let hiddenField = document.createElement("input");
      hiddenField.setAttribute("type", "hidden");
      hiddenField.setAttribute("name", "postid");
      hiddenField.setAttribute("value", selectedPost);
      form.appendChild(hiddenField);

      // Send comment form data as a post request with fetch
      let options = {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ post: selectedPost }),
      };
      fetch("/getonepost", options)
        .then((response) => response.json())
        .then((serverResponse) => renderPost(serverResponse));

      //render the retrieved post data in html
      function renderPost(postData) {
        console.log(postData);
        // show image if present
        if (postData.post.imagePath) {
          postImage.src = postData.post.imagePath;
          postImage.alt = "temporary alt tag";
          postImage.classList.add("cl-post-image");
        } else {
          //render a null image?
        }
        postMessage.innerText = postData.post.message;
        let comments = postData.post.comments;
        if (comments.length > 0) {
          //add a list of comments
          let commentsUL = document.createElement("ul");
          comments.forEach(function (comment) {
            let commentLi = document.createElement("li");
            let commentLiText = document.createElement("p");
            commentLiText.textContent = `${comment.message} (by ${comment.user}) [likes:${comment.likes}]`;
            //add like button and code to handle like later
            commentLi.appendChild(commentLiText);
            commentsUL.appendChild(commentLi);
          });
          postComments.appendChild(commentsUL);
        }
      }

      // ...
      function deletePost(postId) {
        fetch("/deletepost", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ postId }),
        })
          .then((response) => response.json())
          .then((result) => {
            if (result.success) {
              // Post deleted successfully, redirect to the feed
              window.location.href = "/app";
            } else {
              // Show an error message if post deletion fails
              alert("Error deleting post");
            }
          })
          .catch((error) => {
            console.log(error);
            alert("Error deleting post");
          });
      }
    </script>
  </body>
</html>
